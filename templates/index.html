{% extends "base.html" %}
{% set active_page = "index" %}


{% block content %}
<div class="container alert alert-danger alert-dismissable fade">
  <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
  <div id="alert-text"></div>
</div>

<div class="container centered">
  <div>
    <h1> {reezy} </h1>
    <h2 style="text-align: center">Summarized audio for PDFs</h2>
  </div>
  <div class="contents" align="center">
    <form id="upload-file" method="post" enctype="multipart/form-data">
      <fieldset>
        <form class="inline">
          <div class="form-group">
            <label for="time">Length of summary in seconds:</label>
            <input class = "length" type="number" name="length" value="60">
          </div>
        </form>
      </fieldset>
      <div class="filename hide"></div>
        <div id="uploadOptions">
          <fieldset class="fileUpload btn btn-primary button1">
            <span id = "chooseText">Choose File</span>
            <input class="upload" name="file" type="file" id="file">
          </fieldset>
        </div>
      <fieldset>
        <button type="button" class="summary btn button btn-primary button1 hide">Get summary!</button>
      </fieldset>
      <div class="progress progress-striped active hide">
        <div class="progress-bar progress-bar-info" id='realtime-progress-bar' role="progressbar" style="width: 0%"></div>
      </div>
      <p class="messages"></p>
    </form>
  </div>
</div>

<script type="text/javascript">
var pusher = new Pusher('{{ pusher_key }}', {
  encrypted: true
});
var channel = pusher.subscribe('{{ session_id }}');


channel.bind('my-event', function(data) {
  // console.log(data.message);
  var messageBox = $('.messages');
  var progressBar = $('#realtime-progress-bar');

  progressBar.width(data.progress+"%")
  messageBox.html(data.message)

    // The process is complete: do whatever you want now, maybe redirect them to their newly created account?
    if (data.progress == 100) {
      // we'll do something here in the future
    }
  });

channel.bind('done', function(r) {
  $(".summary").removeAttr("disabled");
  var messageBox = $('.messages');

  // handle failure cases
  if (r.data == '') {
    $("#alert-text").html('<strong>Sorry, unable to process PDF.</strong>');
    $(".alert").addClass("in");
    messageBox.html('');
    resetEverything();
  }

  // shouldn't happen
  else if (r.data == 'name') {
    $("#alert-text").html('<strong>Sorry, please submit a file with a name.</strong>');
    $(".alert").addClass("in");
    messageBox.html('');
    resetEverything();
  }

  else if (r.data == 'empty') {
    $("#alert-text").html('<strong>Please upload a PDF with a name.</strong>');
    $(".alert").addClass("in");
    messageBox.html('');
    resetEverything();
  }

  else if (r.data == 'big') {
    $("#alert-text").html('<strong>Please upload a PDF less than 20 pages.</strong>');
    $(".alert").addClass("in");
    messageBox.html('');
    resetEverything();
  }

  else {
    messageBox.html('<a href="' + r.unique_url + '" download>Download the file!</a>')
    done();
  }
})
</script>
{% endblock %}